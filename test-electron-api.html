<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test Electron API</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .test {
      margin: 10px 0;
      padding: 10px;
      background: #2a2a2a;
      border-left: 3px solid #00ff00;
    }
    .error {
      border-left-color: #ff0000;
      color: #ff0000;
    }
    .success {
      border-left-color: #00ff00;
      color: #00ff00;
    }
    button {
      padding: 10px 20px;
      background: #00ff00;
      color: #000;
      border: none;
      cursor: pointer;
      font-family: monospace;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #00cc00;
    }
    pre {
      background: #0a0a0a;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª TEST: Electron API</h1>

  <div id="results"></div>

  <button onclick="runTests()">â–¶ï¸ Ejecutar Tests</button>
  <button onclick="testLogin()">ğŸ” Test Login Flow</button>

  <script>
    const results = document.getElementById('results');

    function log(message, type = 'test') {
      const div = document.createElement('div');
      div.className = `test ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
      console.log(message);
    }

    function runTests() {
      results.innerHTML = '';

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');
      log('TEST 1: window.electronAPI existe', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');

      if (typeof window.electronAPI === 'undefined') {
        log('âŒ window.electronAPI NO EXISTE', 'error');
        log('Esto significa que el preload script no se ejecutÃ³ correctamente', 'error');
        return;
      }

      log('âœ… window.electronAPI EXISTE', 'success');
      log('<pre>' + JSON.stringify(Object.keys(window.electronAPI), null, 2) + '</pre>', 'success');

      log('', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');
      log('TEST 2: window.electronAPI.isElectron', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');

      if (window.electronAPI.isElectron === true) {
        log('âœ… isElectron = true', 'success');
      } else {
        log('âŒ isElectron = ' + window.electronAPI.isElectron, 'error');
      }

      log('', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');
      log('TEST 3: window.electronAPI.db.query', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');

      if (typeof window.electronAPI.db.query === 'function') {
        log('âœ… db.query es una funciÃ³n', 'success');
      } else {
        log('âŒ db.query NO es una funciÃ³n: ' + typeof window.electronAPI.db.query, 'error');
      }

      log('', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');
      log('TEST 4: Ejecutar query SQL', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');

      testQuery();
    }

    async function testQuery() {
      try {
        log('Ejecutando: SELECT * FROM users', 'test');

        const result = await window.electronAPI.db.query('SELECT * FROM users');

        log('âœ… Query ejecutada exitosamente', 'success');
        log('<pre>' + JSON.stringify(result, null, 2) + '</pre>', 'success');

        if (result.success && result.data && result.data.length > 0) {
          log('âœ… Usuarios encontrados: ' + result.data.length, 'success');
          result.data.forEach((user, i) => {
            log(`   ${i + 1}. ${user.username} (${user.role})`, 'success');
          });
        } else {
          log('âŒ No se encontraron usuarios', 'error');
        }
      } catch (error) {
        log('âŒ Error ejecutando query:', 'error');
        log('<pre>' + error.message + '</pre>', 'error');
      }
    }

    async function testLogin() {
      results.innerHTML = '';

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');
      log('TEST: Login Flow Completo', 'test');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'test');

      try {
        // PASO 1: Verificar que electronAPI existe
        if (!window.electronAPI || !window.electronAPI.isElectron) {
          log('âŒ ERROR: No estamos en Electron', 'error');
          return;
        }
        log('âœ… Estamos en Electron', 'success');

        // PASO 2: Query usuarios
        log('', 'test');
        log('Ejecutando: SELECT * FROM users', 'test');
        const result = await window.electronAPI.db.query('SELECT * FROM users');

        if (!result.success) {
          log('âŒ Query fallÃ³: ' + result.error, 'error');
          return;
        }

        const users = result.data || [];
        log(`âœ… Query exitosa. Usuarios: ${users.length}`, 'success');

        if (users.length === 0) {
          log('âŒ No hay usuarios en la base de datos', 'error');
          return;
        }

        // PASO 3: Intentar login (sin bcrypt, solo verificar que el usuario existe)
        log('', 'test');
        log('Usuario encontrado:', 'success');
        log(`   Username: ${users[0].username}`, 'success');
        log(`   Role: ${users[0].role}`, 'success');
        log(`   Password Hash: ${users[0].password_hash.substring(0, 29)}...`, 'success');

        log('', 'test');
        log('ğŸ‰ LOGIN DEBERÃA FUNCIONAR', 'success');
        log('El usuario existe y la query funciona.', 'success');
        log('El problema podrÃ­a estar en bcrypt.compareSync o en la lÃ³gica de authService', 'success');

      } catch (error) {
        log('âŒ Error en test de login:', 'error');
        log('<pre>' + error.message + '\\n' + error.stack + '</pre>', 'error');
      }
    }

    // Auto-ejecutar tests al cargar
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(runTests, 500);
    });
  </script>
</body>
</html>
